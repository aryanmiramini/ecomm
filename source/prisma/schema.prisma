// Prisma Schema for E-commerce Application
// Database: PostgreSQL with UUID primary keys

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ENUMS
// =====================================================

enum UserRole {
  ADMIN
  CUSTOMER
  VENDOR
}

enum OrderStatus {
  PENDING
  PROCESSING
  CONFIRMED
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum ShippingMethod {
  STANDARD
  EXPRESS
  OVERNIGHT
  PICKUP
}

enum NotificationType {
  ORDER_CONFIRMATION
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  PRICE_DROP
  BACK_IN_STOCK
  PROMOTION
  REVIEW_RESPONSE
  GENERAL
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// =====================================================
// USER MODEL
// =====================================================

model User {
  id                      String         @id @default(uuid()) @db.Uuid
  email                   String?        @unique
  password                String?
  firstName               String?
  lastName                String?
  phone                   String         @unique
  avatar                  String?
  dateOfBirth             DateTime?      @db.Date
  shippingAddress         String?        @db.Text
  billingAddress          String?        @db.Text
  city                    String?
  state                   String?
  postalCode              String?
  country                 String?        @default("United States")
  role                    UserRole       @default(CUSTOMER)
  isActive                Boolean        @default(true)
  isEmailVerified         Boolean        @default(false)
  emailVerificationToken  String?
  resetPasswordToken      String?
  resetPasswordExpires    DateTime?
  lastLoginAt             DateTime?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt

  // Relations
  orders                  Order[]
  reviews                 Review[]
  wishlist                Wishlist[]
  carts                   Cart[]
  notifications           Notification[]
  otpCodes                OtpCode[]

  @@map("users")
}

// =====================================================
// OTP CODES (for SMS login/signup)
// =====================================================

model OtpCode {
  id         String   @id @default(uuid()) @db.Uuid
  phone      String
  code       String
  expiresAt  DateTime
  used       Boolean  @default(false)
  attempts   Int      @default(0)
  createdAt  DateTime @default(now())

  // Relations
  userId     String?  @db.Uuid
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([phone])
  @@map("otp_codes")
}

// =====================================================
// CATEGORY MODEL
// =====================================================

model Category {
  id          String     @id @default(uuid()) @db.Uuid
  name        String     @unique
  description String?    @db.Text
  slug        String?    @unique
  image       String?
  icon        String?
  isActive    Boolean    @default(true)
  sortOrder   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Self-referential relation for parent/child categories
  parentId    String?    @db.Uuid
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryHierarchy")

  // Relations
  products    Product[]

  @@map("categories")
}

// =====================================================
// PRODUCT MODEL
// =====================================================

model Product {
  id                  String      @id @default(uuid()) @db.Uuid
  name                String
  description         String      @db.Text
  price               Decimal     @db.Decimal(10, 2)
  originalPrice       Decimal?    @db.Decimal(10, 2)
  discountPercentage  Decimal     @default(0) @db.Decimal(5, 2)
  sku                 String      @unique
  quantity            Int         @default(0)
  brand               String?
  model               String?
  rating              Decimal     @default(0) @db.Decimal(3, 2)
  reviewCount         Int         @default(0)
  images              String[]
  weight              Decimal?    @db.Decimal(10, 2)
  dimensions          String?
  color               String?
  size                String?
  tags                String[]
  isActive            Boolean     @default(true)
  isFeatured          Boolean     @default(false)
  condition           String      @default("new")
  warranty            String?     @db.Text
  shippingInfo        String?     @db.Text
  madeIn              String?
  viewCount           Int         @default(0)
  purchaseCount       Int         @default(0)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  // Foreign Keys
  categoryId          String      @db.Uuid
  category            Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // Relations
  reviews             Review[]
  orderItems          OrderItem[]
  cartItems           CartItem[]
  wishlist            Wishlist[]

  @@map("products")
}

// =====================================================
// ORDER MODELS
// =====================================================

model Order {
  id                      String          @id @default(uuid()) @db.Uuid
  orderNumber             String?         @unique
  status                  OrderStatus     @default(PENDING)
  paymentStatus           PaymentStatus   @default(PENDING)
  subtotal                Decimal         @db.Decimal(10, 2)
  tax                     Decimal         @default(0) @db.Decimal(10, 2)
  shipping                Decimal         @default(0) @db.Decimal(10, 2)
  discount                Decimal         @default(0) @db.Decimal(10, 2)
  total                   Decimal         @db.Decimal(10, 2)
  couponCode              String?
  shippingAddress         String?         @db.Text
  billingAddress          String?         @db.Text
  shippingFirstName       String?
  shippingLastName        String?
  shippingPhone           String?
  shippingEmail           String?
  shippingMethod          ShippingMethod  @default(STANDARD)
  paymentMethod           String?
  paymentIntentId         String?
  trackingNumber          String?
  carrier                 String?
  trackingUrl             String?
  notes                   String?         @db.Text
  adminNotes              String?         @db.Text
  ipAddress               String?
  userAgent               String?         @db.Text
  itemCount               Int             @default(0)
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  paidAt                  DateTime?
  shippedAt               DateTime?
  deliveredAt             DateTime?
  cancelledAt             DateTime?
  estimatedDeliveryDate   DateTime?

  // Foreign Keys
  userId                  String          @db.Uuid
  user                    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  items                   OrderItem[]

  @@map("orders")
}

model OrderItem {
  id                  String   @id @default(uuid()) @db.Uuid
  quantity            Int
  price               Decimal  @db.Decimal(10, 2)
  subtotal            Decimal  @db.Decimal(10, 2)
  discountPercentage  Decimal  @default(0) @db.Decimal(5, 2)
  discountAmount      Decimal  @default(0) @db.Decimal(10, 2)
  taxAmount           Decimal  @default(0) @db.Decimal(10, 2)
  total               Decimal  @default(0) @db.Decimal(10, 2)

  // Foreign Keys
  orderId             String   @db.Uuid
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId           String   @db.Uuid
  product             Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

// =====================================================
// CART MODELS
// =====================================================

model Cart {
  id          String     @id @default(uuid()) @db.Uuid
  isActive    Boolean    @default(true)
  couponCode  String?
  totalAmount Decimal    @default(0) @db.Decimal(10, 2)
  itemCount   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Foreign Keys
  userId      String     @db.Uuid
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  items       CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid()) @db.Uuid
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  subtotal  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Foreign Keys
  cartId    String   @db.Uuid
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  productId String   @db.Uuid
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("cart_items")
}

// =====================================================
// REVIEW MODEL
// =====================================================

model Review {
  id                 String   @id @default(uuid()) @db.Uuid
  rating             Int
  comment            String   @db.Text
  title              String?
  isVerifiedPurchase Boolean  @default(false)
  isApproved         Boolean  @default(true)
  helpfulCount       Int      @default(0)
  unhelpfulCount     Int      @default(0)
  images             String[]
  adminResponse      String?  @db.Text
  adminResponseAt    DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Foreign Keys
  userId             String   @db.Uuid
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  productId          String   @db.Uuid
  product            Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

// =====================================================
// WISHLIST MODEL
// =====================================================

model Wishlist {
  id        String   @id @default(uuid()) @db.Uuid
  note      String?  @db.Text
  priority  Int      @default(3)
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())

  // Foreign Keys
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  productId String   @db.Uuid
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("wishlists")
}

// =====================================================
// NOTIFICATION MODEL
// =====================================================

model Notification {
  id          String               @id @default(uuid()) @db.Uuid
  title       String
  message     String               @db.Text
  type        NotificationType     @default(GENERAL)
  priority    NotificationPriority @default(MEDIUM)
  read        Boolean              @default(false)
  actionUrl   String?
  metadata    Json?
  createdAt   DateTime             @default(now())
  readAt      DateTime?

  // Foreign Keys
  userId      String               @db.Uuid
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
